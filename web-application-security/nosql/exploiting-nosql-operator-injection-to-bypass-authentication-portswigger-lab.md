# Exploiting NoSQL operator injection to bypass authentication (PortSwigger Lab)

## NoSQL Injection – Bypassing Authentication (MongoDB)

### **Lab Overview**

**Lab URL:** [PortSwigger: NoSQL Injection – Authentication Bypass](https://portswigger.net/web-security/nosql-injection/lab-nosql-injection-bypass-authentication)

#### **Objective**

This lab demonstrates how NoSQL injection can be exploited in a MongoDB-based authentication system. The vulnerability allows an attacker to manipulate query operators such as `$ne` (not equal) and `$regex` (pattern matching) to bypass authentication and log in as an administrator.

#### **Key Takeaways**

* NoSQL databases (such as MongoDB) process JSON-based queries, making them susceptible to injection if user input is not properly sanitized.
* NoSQL injection can lead to authentication bypass, unauthorized data access, or full database compromise.
* Operators such as `$ne` and `$regex` allow attackers to manipulate query logic and match unintended users.

***

### **Technical Background**

#### **Definition Table**

| **Term**            | **Definition**                                                                                                                      |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **NoSQL Injection** | A vulnerability where attacker-controlled input manipulates NoSQL queries, leading to authentication bypass or unauthorized access. |
| **MongoDB**         | A document-based NoSQL database that stores data in JSON-like structures.                                                           |
| **$ne Operator**    | "Not equal to" operator in MongoDB, which can be used to match all non-empty values.                                                |
| **$regex Operator** | A pattern-matching operator in MongoDB used to filter documents based on string patterns.                                           |
| **302 Redirect**    | An HTTP status code indicating successful authentication, often redirecting to a user dashboard.                                    |
| **Burp Repeater**   | A tool in Burp Suite for modifying and resending HTTP requests to analyze server responses.                                         |

***

### **Real-World Example: MongoDB Authentication Bypass**

#### **GitHub NoSQL Injection Vulnerability (2012)**

* **Incident:** A MongoDB-powered authentication system on GitHub was found to be vulnerable to NoSQL injection.
* **Attack Method:**
  *   Attackers sent the following payload:

      ```json
      { "username": { "$gt": "" }, "password": { "$gt": "" } }
      ```
  * This query matched any user where `username` and `password` were not empty, effectively bypassing authentication.
* **Resolution:** GitHub enforced strict input validation and parameterized queries to prevent NoSQL injection attacks.

#### **Reference**

* [OWASP NoSQL Injection](https://owasp.org/www-community/attacks/NoSQL_Injection)

***

### **Step-by-Step Exploitation Process**

#### **Step 1: Capturing a Normal Login Request**

1. Navigate to the login page.
2. Enter the provided credentials (`wiener:peter`).
3. Use Burp Suite to intercept the `POST /login` request.

**Example Login Request (Intercepted in Burp)**

```json
{
  "username": "wiener",
  "password": "peter"
}
```

***

#### **Step 2: Sending the Request to Burp Repeater**

* Right-click the request and select **Send to Repeater**.
* In Burp Repeater, modify the request to inject NoSQL payloads.

***

#### **Step 3: Injecting the `$ne` Operator**

* MongoDB allows the use of query operators within JSON-based queries.
* Modify the request as follows:

```json
{
  "username": { "$ne": "" },
  "password": "peter"
}
```

* **Expected Result:** If the application is vulnerable, this may return a valid user session or alter the server’s response.

**Why `$ne` Works**

*   The modified query in MongoDB:

    ```javascript
    db.users.find({ "username": { "$ne": "" }, "password": "peter" });
    ```
* This matches any user where `username` is not empty. If improperly validated, the query returns multiple user accounts, potentially allowing authentication bypass.

***

#### **Step 4: Using `$regex` to Match Admin Accounts**

* Modify the request further to specifically target an administrator account:

```json
{
  "username": { "$regex": "admin.*" },
  "password": { "$ne": "" }
}
```

**Why `$regex` Works**

*   The query now becomes:

    ```javascript
    db.users.find({ "username": { "$regex": "admin.*" }, "password": { "$ne": "" } });
    ```
* This matches any username that starts with `"admin"`, even if the attacker does not know the full username.

***

#### **Step 5: Confirming Authentication Success**

1. Send the modified request.
2. Check for a **302 Found** response, indicating successful authentication.
3. Look for a **Set-Cookie** header containing a session token.

***

#### **Step 6: Using the Administrator Session**

* Copy the session token from the response.
* Replace the existing session cookie in the browser or Burp Suite.
* Navigate to the account dashboard and verify that administrator privileges have been obtained.

***

### **Exam Readiness & Attack Methodology**

#### **NoSQL Injection Testing Workflow**

1. **Identify Input Fields:** Locate authentication forms, search parameters, or API endpoints that interact with a NoSQL database.
2. **Test for Injection:** Use `$ne` to determine if query operators are being processed.
3. **Refine the Attack:** Apply `$regex` to target specific user accounts dynamically.
4. **Observe Response Behavior:** Look for differences in response codes, redirects, or data leakage.
5. **Confirm Exploitation:** If authentication bypass is achieved, attempt further privilege escalation.

***

### **Remediation Strategies**

#### **1. Enforce Input Validation**

* Block MongoDB operators (`$ne`, `$regex`, `$gt`, etc.) in user input.
* Use a validation library such as `mongo-sanitize` to strip malicious input.

**Example Validation Code**

```javascript
const sanitize = require('mongo-sanitize');
const username = sanitize(req.body.username);
const password = sanitize(req.body.password);
```

#### **Reference**

* [MongoDB Sanitize](https://www.npmjs.com/package/mongo-sanitize)

***

#### **2. Implement Parameterized Queries**

* Use parameterized queries to separate user input from database logic.

**Secure Query Example (Mongoose ORM)**

```javascript
User.findOne({ username: req.body.username, password: req.body.password }).exec();
```

#### **Reference**

* [MongoDB Query Best Practices](https://www.mongodb.com/docs/manual/core/security-query-best-practices/)

***

#### **3. Restrict NoSQL Query Operators**

* Implement schema validation to prevent users from injecting query logic.

**Example Secure Schema (Mongoose)**

```javascript
const userSchema = new Schema({
  username: { type: String, match: /^[a-zA-Z0-9]+$/ },
  password: { type: String }
});
```

#### **Reference**

* [OWASP NoSQL Injection Prevention](https://owasp.org/www-community/attacks/NoSQL_Injection)

***

#### **4. Implement Rate-Limiting & Logging**

* Monitor authentication attempts and log suspicious behavior.
* Implement rate-limiting to prevent brute-force NoSQL injection attacks.

#### **Reference**

* [OWASP Logging Best Practices](https://owasp.org/www-project-logging/)

***

### **Final Key Takeaways**

* NoSQL injection exploits the flexible querying of databases like MongoDB, allowing unauthorized access.
* The use of `$ne` and `$regex` in authentication bypass attacks has been demonstrated in real-world vulnerabilities.
* Proper input validation, query parameterization, and logging are crucial defenses against NoSQL injection.

***

### **Further Reading & References**

* [PortSwigger NoSQL Injection Labs](https://portswigger.net/web-security/nosql-injection)
* [OWASP NoSQL Injection Prevention](https://owasp.org/www-community/attacks/NoSQL_Injection)
* [MongoDB Security Checklist](https://www.mongodb.com/docs/manual/administration/security-checklist/)
