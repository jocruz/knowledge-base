# Exploiting a Mass Assignment Vulnerability (PortSwigger Lab)

## **Lab: Exploiting a Mass Assignment Vulnerability**

**Lab URL:** [PortSwigger - Exploiting Mass Assignment](https://portswigger.net/web-security/api-testing/lab-exploiting-mass-assignment-vulnerability)

***

### **High-Level Summary**

#### **Objective**

Identify and exploit a **mass assignment vulnerability** to apply an unauthorized discount and complete the purchase of a **Lightweight "l33t" Leather Jacket** despite insufficient funds.

#### **Key Techniques & Concepts**

* **Mass Assignment Vulnerability:** Allows unauthorized modification of **sensitive object properties** due to improper API validation.
* **API Parameter Tampering:** Identifying **hidden fields** that can be manipulated in API requests.
* **Burp Suite Analysis:** Inspecting and modifying API requests to introduce unauthorized values.

#### **What Makes This Vulnerable?**

* The API **accepts additional parameters** (`chosen_discount`) in the `POST /api/checkout` request, which allows users to **apply unauthorized discounts** without server-side validation.

***

### **PortSwigger Solution Steps**

#### **Step 1: Log Into the Lab**

*   Use the provided credentials:

    ```
    Username: wiener  
    Password: peter  
    ```

#### **Step 2: Add the Product to Basket**

* Select **Lightweight "l33t" Leather Jacket** and add it to the shopping cart.
* Navigate to the **checkout page** and attempt to place an order.
* Observe that **there is insufficient credit** for the purchase.

#### **Step 3: Capture and Analyze API Requests in Burp Suite**

* Open **Burp Suite** and go to **Proxy > HTTP History**.
* Look for API requests related to the checkout process (`/api/checkout`).

**GET Request to `/api/checkout` (Identifying Parameters)**

* The **GET response** reveals a `chosen_discount` parameter:

```json
{
  "chosen_discount": { "percentage": 0 },
  "chosen_products": [
    { "product_id": "1", "quantity": 1, "name": "Lightweight \"l33t\" Leather Jacket" }
  ],
  "item_price": 133700
}
```

* This suggests that the API **tracks discount values**, but the **POST request does not include this field**.

**POST Request to `/api/checkout` (Missing Parameters)**

* The **original POST request** lacks the `chosen_discount` field:

```json
{
  "chosen_products": [
    { "product_id": "1", "quantity": 1 }
  ]
}
```

#### **Step 4: Modify the POST Request**

* Send the `POST /api/checkout` request to **Burp Repeater**.
* Modify the payload to **include the `chosen_discount` parameter** with a value of `100`:

```json
{
  "chosen_discount": { "percentage": 100 },
  "chosen_products": [
    { "product_id": "1", "quantity": 1 }
  ]
}
```

#### **Step 5: Send the Modified Request**

* Submit the modified request in **Burp Repeater**.
* If successful, a `201 Created` response should be returned.

#### **Step 6: Verify Lab Completion**

* Return to the **lab interface** and confirm the order was placed successfully.
* The lab should display a **completion message**.

***

### **Instructor Solution Steps**

#### **Step 1: Log Into the Application**

* Authenticate using `wiener:peter`.
* Add the **Lightweight "l33t" Leather Jacket** to the cart.

#### **Step 2: Intercept Checkout Requests in Burp Suite**

* Analyze **both GET and POST requests** to `/api/checkout`.

#### **Step 3: Identify the Vulnerability**

* The **GET response** includes the `chosen_discount` field, but the **POST request does not**.

#### **Step 4: Modify and Send the Exploit Payload**

* Inject the following modified JSON into the `POST` request:

```json
{
  "chosen_discount": { "percentage": 100 },
  "chosen_products": [
    { "product_id": "1", "quantity": 1 }
  ]
}
```

#### **Step 5: Confirm Exploitation Success**

* If the API **does not validate the input**, the discount is applied, and the product is purchased for free.
* The lab is successfully completed.

***

### **Explanation of the Vulnerability and Attack**

#### **Mass Assignment Vulnerability**

* Many web frameworks automatically **bind JSON request parameters** to **internal object properties**.
* If the developer does not **restrict modifiable fields**, users can **manipulate hidden parameters** in API requests.

#### **Why This Attack Works**

1. **The API does not restrict the `chosen_discount` field** in `POST /api/checkout`.
2. **The front-end does not include this parameter**, but the backend still accepts it.
3. **Manually inserting `chosen_discount` bypasses authorization checks**, allowing the discount to be applied.

#### **Key Indicators of Mass Assignment**

* **Mismatch Between GET and POST Requests:** If `GET` responses include fields that are missing in `POST` requests, those fields might be modifiable.
* **Hidden Fields in JSON Responses:** Sensitive parameters (e.g., `is_admin`, `discount`, `role`) appearing in API responses may indicate mass assignment risks.
* **Lack of Server-Side Validation:** The server should ignore **unexpected fields**, but a vulnerable API processes them instead.

***

### **Tools and Techniques Used**

#### **Tools**

* **Burp Suite:** Intercept and modify API requests.
* **Postman:** Alternative tool for API manipulation.
* **cURL:** Command-line API testing.

#### **Exploitable API Request Example**

```http
POST /api/checkout HTTP/1.1
Host: vulnerable-app.com
Content-Type: application/json

{
  "chosen_discount": { "percentage": 100 },
  "chosen_products": [
    { "product_id": "1", "quantity": 1 }
  ]
}
```

***

### **Real-World Mass Assignment Vulnerabilities**

#### **1. GitHub API Mass Assignment Flaw (CVE-2012-6708)**

* GitHub's API allowed attackers to **modify private repositories** by injecting a `public: true` field in API requests.
* Reference: [CVE-2012-6708](https://nvd.nist.gov/vuln/detail/CVE-2012-6708)

#### **2. Shopify Mass Assignment Vulnerability**

* Researchers discovered that Shopifyâ€™s API allowed users to **escalate their permissions** by modifying request payloads.
* Reference: [HackerOne Report](https://hackerone.com/reports/207336)

#### **3. Facebook API Exploitation via Mass Assignment**

* Attackers could change **email addresses linked to accounts** by injecting an unexpected `email` parameter in API requests.
* Reference: [Facebook Security Issue](https://www.securityweek.com/facebook-fixes-mass-assignment-vulnerability/)

***

### **How to Prevent Mass Assignment Vulnerabilities**

#### **1. Implement an Explicit Allowlist for User Input**

* Define **allowed fields** explicitly to prevent unauthorized modifications.

```javascript
const allowedFields = ["firstName", "lastName", "email"];
const user = {};

allowedFields.forEach(field => {
    if (req.body[field]) {
        user[field] = req.body[field];
    }
});
```

#### **2. Use ORM Safeguards**

* Most **Object-Relational Mappers (ORMs)** offer mass assignment protection.
* Example in **Sequelize ORM** (Node.js):

```javascript
const User = sequelize.define('User', {
    username: Sequelize.STRING,
    isAdmin: { type: Sequelize.BOOLEAN, allowNull: false }
}, { timestamps: false });
```

#### **3. Validate Input on the Server**

* Reject unexpected fields in API requests.

```javascript
app.post("/api/checkout", (req, res) => {
    if ("chosen_discount" in req.body) {
        return res.status(400).json({ error: "Unauthorized field detected." });
    }
});
```

***

### **Final Takeaways**

* **Mass assignment vulnerabilities occur when APIs accept unvalidated input fields.**
* **Attackers can modify hidden parameters to escalate privileges or alter transactions.**
* **Strict input validation, ORM security features, and allowlists prevent exploitation.**
